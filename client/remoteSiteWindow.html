<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Connect to Remote Site</title>
    <script>
        // Renaming require keyword to be able to use jQuery and node in electron, load node modules with nodeRequire()
        window.nodeRequire = require;
        delete window.require;
        delete window.exports; delete window.module; 
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>


</head>

<body>
    <div class='container'>
        <form>
            <div>
                <label>Enter URL of Remote Site</label>
                <div>
                    <div class='inline'>
                        <input type="text" id="url" autofocus>
                    </div>
                    <!-- Dropdown Trigger -->
                    <a class='dropdown-trigger btn inline blue-grey darken-2' href='#' data-target='dropdown1'>Known
                        sites</a>

                    <!-- Dropdown Structure -->
                    <ul id='dropdown1' class='dropdown-content'>
                        <li><a class='clickable'>canopus.evl.uic.edu</a></li>
                    </ul>
                </div>
            </div>
            <p>
                <label>
                    <input class='checkb' id='check_1' type="checkbox" />
                    <span>Display client ID #</span>
                </label>
            </p>
            <div id='display-id-div' class="input-field inline">
                <input id="display_id" type="text">
                <label for="email_inline">Display ID</label>
            </div>
            <p>
                <label>
                    <input class='checkb' id='check_2' type="checkbox" checked='true' />
                    <span>Full Screen</span>
                </label>
            </p>
            <button class='btn waves-effect wave-lights blue-grey darken-2' type="submit"><i
                    class="material-icons left">screen_share</i>Mirror screen</button>
        </form>

    </div>
    <style>
        .inline {
            display: inline-block;
            width: 45%;

        }

        /* #url{
            width: 1000%;
        } */
    </style>
    <script>
        const electron = nodeRequire('electron');
        const { ipcRenderer } = electron;
        const url_sites = 'https://canopus.evl.uic.edu/config';

        // Utility method for jQuery
        $.extend({
            el: function (el, attributes = {}) {
                var $el = $(document.createElement(el));
                $el.attr(attributes);
                return $el;
            }
        });

        //logging function
        function l(item) {
            console.log(item);
        }

        // Change text box on click of drop down
        function changeInput(e) {
            $("#url").val(e.target.innerHTML); //because it is an input, use .val() to set and .html() to get
        }

        function attachBehaviorDropdownItems() {
            const dropd = document.querySelectorAll('.clickable');

            dropd.forEach(function (item) {
                item.addEventListener('click', changeInput);
            });
        }

        /**
         * Checks json and creates dropdown list
         */
        function createDropdownList(config_json) {
            if(!config_json.remote_sites){
                return;
            }
            config_json.remote_sites.forEach(createDropItem);
            attachBehaviorDropdownItems();
        }

        // Creates an item for the dropdown menu
        function createDropItem(item, index) {
            $('#dropdown1').append(
                $.el('li').append(
                    $.el('a', { class: 'clickable' }).text(item.host)
                )
            );
        }

        // Take site url and format it properly
        function formatProperly(url) {
            const url_start = 'https://';
            var $check1 = $('#check_1')[0];
            if (!url.startsWith('http://') || !url.startsWith('https://')) {
                url = url_start + url;
            }

            // If display number is toggled then take the ID, if NaN do full sscreen
            if ($check1.checked) {
                var id = isNaN(parseInt($('#display_id').val())) ? -1 : parseInt($('#display_id').val());
                /**
                 * ! Change with max ID that I don't know
                 */
                if(id > -2 && id < 18){
                    url = url + '/display.html?clientID='+id;
                }
            }
            else {
                url = url + '/display.html?clientID=-1';
            } 
            return url;
        }

        /**
         * TODO add string input control before sending ipc
         * Mirror Screen button handler. Creates the url based on user input and sends it to the main electron.js
         * 
         */
        const form = document.querySelector('form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            let URL = document.querySelector('#url').value;

            URL = formatProperly(URL);
            //sending URL to electron.js, params: key value pair (id,URL)
            ipcRenderer.send('connect-url', URL);
        });

        /**
         * ! Need to test in case config fetch is not okay
         */
        function fetchWithTimeout(url, delay, onTimeout) {
            const timer = new Promise((resolve) => {
                setTimeout(resolve, delay, {
                    timeout: true,
                });
            });

            return Promise.race([
                fetch(url),
                timer
            ]).then((response) => {
                if (response.timeout) {
                    onTimeout();
                    return;
                }
                return response;
            }).then(response => response.json())
            .then((json) =>{
                createDropdownList(json);
            });
        }

        // Initialize dropdown with sites
        document.addEventListener('DOMContentLoaded', function () {
            var elems = document.querySelectorAll('.dropdown-trigger');
            options = {
                edge: 'left',
                hover: true
            }
            var instances = M.Dropdown.init(elems, options);

            attachBehaviorDropdownItems();
            $("#display-id-div").hide();

            // fetch(url_sites)
            fetchWithTimeout(url_sites, 1000, () => { l('Canopus site server down, timeout reached, refresh to try again') })
                .catch(err => { throw err });
        });

        /**
         * Making sure only one of the check boxes are selected and dynamically unselect
         */
        $('.checkb').click(function () {
            var checked = $(this)[0].checked;
            var $check1 = $('#check_1')[0];
            var $check2 = $('#check_2')[0];
            if (checked) {
                if ($(this)[0].id === 'check_1') {
                    if ($check2.checked) {
                        $check2.checked = false;
                    }
                    $("#display-id-div").show();
                } else {
                    if ($check1.checked) {
                        $check1.checked = false;
                    }
                    $("#display-id-div").hide();
                }
            }
        });

    </script>
</body>

</html>