<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Connect to Remote Site</title>
    <script>
        // Renaming require keyword to be able to use jQuery and node in electron, load node modules with nodeRequire()
        window.nodeRequire = require;
        delete window.require;
        delete window.exports; delete window.module; 
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>


</head>

<body>
    <div class='container'>
        <form action="">
            <div class="row">
                <div class="col s8"><label>Enter URL of Remote Site</label>
                    <div class="input-field">
                        <!-- favorite and favorite_border -->
                        <i class="material-icons prefix">favorite_border</i>
                        <input type="text" id="url" autofocus>
                    </div>
                    <div>
                        <!-- Dropdown Trigger -->
                        <a class='dropdown-trigger btn blue-grey darken-2 z-depth-3' href='#' data-target='sites_dropdown'>Known
                            sites</a>
                        <!-- Dropdown Structure -->
                        <ul id='sites_dropdown' class='dropdown-content'>
                            <!-- <li><a class='clickable'>canopus.evl.uic.edu</a></li> -->
                        </ul>
                    </div>
                </div>
                <div class="col s4"><label>Options</label>

                    <br><br>
                    <p>
                        <label>
                            <input class='checkb' id='check_2' type="checkbox" checked='true' />
                            <span>Display Full Wall</span>
                        </label>
                    </p>
                    <div class="row">
                      <div class="col s10"> 
                    <p>
                        <label>
                            <input class='checkb' id='check_1' type="checkbox" />
                            <span>Display client ID</span>
                        </label>
                    </p>
                </div> 
                <div class="col s1"><div id='display-id-div'>
                        <!-- Dropdown Trigger -->
                        <a id="id_drop" class='dropdown-trigger btn blue-grey darken-2 z-depth-3 scale-transition scale-out' href='#'
                            data-target='ids_dropdown'>ID</a>
                        <!-- Dropdown Structure -->
                        <ul id='ids_dropdown' class='dropdown-content'>
                            <!-- <li><a class='clickable'>0</a></li> -->
                        </ul>
                    </div></div>
                </div>
                    <!-- <div id='display-id-div' class="input-field inline">
                            <input id="display_id" type="text">
                            <label for="email_inline">Display ID</label>
                        </div> -->
            
                </div>
            </div>
            <button class='btn waves-effect wave-lights blue-grey darken-2 z-depth-3' type="submit"><i
                    class="material-icons left">screen_share</i>Okay</button>
        </form>
    </div>
    <!-- <style>
        .inline {
            display: inline-block;
            width: 45%;

        }

        #left_panel {
            float: left;
            width: 60%;
        }

        #url {
            width:80%;
        }

        #right_panel {
            float: left;
            width: 35%;
        }

        /* #url{
                width: 1000%;
            } */
    </style> -->
    <script>
        const electron = nodeRequire('electron');
        const { ipcRenderer } = electron;
        const default_config_url = 'https://canopus.evl.uic.edu/config';

        // Utility method for jQuery
        $.extend({
            el: function (el, attributes = {}) {
                var $el = $(document.createElement(el));
                $el.attr(attributes);
                return $el;
            }
        });

        //logging function
        function l(item) {
            console.log(item);
        }

        function buildConfigURL(domain){
            return 'https://' + domain + '/config';
        }

        // Change text box on click of drop down
        function sitesOnClick(e) {
            $("#url").val(e.target.innerHTML); //because it is an input, use .val() to set and .html() to get
            fetchWithTimeout(buildConfigURL(e.target.innerHTML), 1000, () => { l('Canopus site server down, timeout reached, refresh to try again') })
                .catch(err => { throw err });
        }

        function attachBehaviorDropdownSites() {
            const dropd = document.querySelectorAll('.clickable');

            dropd.forEach(function (item) {
                item.addEventListener('click', sitesOnClick);
            });
        }

        function attachBehaviorDropdownIds() {
            const dropd = document.querySelectorAll('.clickable-id');

            dropd.forEach(function (item) {
                item.addEventListener('click', (e) => {
                    $("#id_drop").text(e.target.innerHTML);
                });
            });
        }

        function removePreviousDropdownItem(ul_id){
            document.getElementById(ul_id).innerHTML = "";
        }

        function populateUI(config_json) {
            removePreviousDropdownItem("sites_dropdown");
            removePreviousDropdownItem("ids_dropdown");

            populateDropdownSites(config_json.remote_sites);
            populateDropdownIds(config_json.displays);
            // TODO password
        }

        function populateDropdownIds(display_ids) {
            // l(config_json)
            if (!display_ids) {
                return;
            }
            display_ids.forEach(createDropItemIds);
            attachBehaviorDropdownIds();
        }

        /**
         * Checks json and creates dropdown list
         */
        function populateDropdownSites(remote_sites) {
            if (!remote_sites) {
                return;
            }
            remote_sites.forEach(createDropItemSites);
            attachBehaviorDropdownSites();
        }

        // Creates an item for the dropdown menu
        function createDropItemSites(item, index) {
            $('#sites_dropdown').append(
                $.el('li').append(
                    $.el('a', { class: 'clickable' }).text(item.host)
                )
            );
        }

        function createDropItemIds(item, index) {
            $('#ids_dropdown').append(
                $.el('li').append(
                    $.el('a', { class: 'clickable-id' }).text(index)
                )
            );
        }

        // Take site url and format it properly
        function formatProperly(url) {
            const url_start = 'https://';
            var $check1 = $('#check_1')[0];
            if (!url.startsWith('http://') || !url.startsWith('https://')) {
                url = url_start + url;
            }

            // If display number is toggled then take the ID, if NaN do full sscreen
            if ($check1.checked) {
                var id_element = document.getElementById('id_drop');
                var id = isNaN(parseInt(id_element.innerHTML)) ? -1 : parseInt(id_element.innerHTML);

                if (id > -2) {
                    url = url + '/display.html?clientID=' + id;
                }
            }
            else {
                url = url + '/display.html?clientID=-1';
            }
            return url;
        }

        /**
         * TODO add string input control before sending ipc
         * Mirror Screen button handler. Creates the url based on user input and sends it to the main electron.js
         * 
         */
        const form = document.querySelector('form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            let URL = document.querySelector('#url').value;

            URL = formatProperly(URL);
            //sending URL to electron.js, params: key value pair (id,URL)
            ipcRenderer.send('connect-url', URL);
        });

        /**
         * ! Need to test in case config fetch is not okay
         */
        function fetchWithTimeout(url, delay, onTimeout) {
            const timer = new Promise((resolve) => {
                setTimeout(resolve, delay, {
                    timeout: true,
                });
            });

            return Promise.race([
                fetch(url),
                timer
            ]).then((response) => {
                if (response.timeout) {
                    onTimeout();
                    return null;
                } else {
                    return response.json();
                }
            }).then((json) => {
                if (json) {
                    populateUI(json);
                }
            });
        }

        // Initialize dropdown with sites
        document.addEventListener('DOMContentLoaded', function () {
            var elems = document.querySelectorAll('.dropdown-trigger');
            options = {
                edge: 'left',
                hover: true
            }
            var instances = M.Dropdown.init(elems, options);

            attachBehaviorDropdownSites();
            // $("#display-id-div").hide();

            // fetch(default_config_url)
            fetchWithTimeout(default_config_url, 1000, () => { l('Canopus site server down, timeout reached, refresh to try again') })
                .catch(err => { throw err });
        });

        /**
         * Making sure only one of the check boxes are selected and dynamically unselect
         */
        $('.checkb').click(function () {
            var checked = $(this)[0].checked;
            var $check1 = $('#check_1')[0];
            var $check2 = $('#check_2')[0];
            if (checked) {
                if ($(this)[0].id === 'check_1') {
                    if ($check2.checked) {
                        $check2.checked = false;
                    }
                    $("#id_drop").addClass('scale-in');
                    // $("#display-id-div").show();
                } else {
                    if ($check1.checked) {
                        $check1.checked = false;
                    }
                    $("#id_drop").removeClass('scale-in');
                    // $("#display-id-div").hide();
                }
            }
        });

    </script>
</body>

</html>