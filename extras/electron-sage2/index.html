<!DOCTYPE html>
<html>
	<head lang="en">
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />

    <meta charset="UTF-8">
    <title>SAGE2™</title>

	<link rel="stylesheet" type="text/css" href="css/fonts.css"/>
	<link rel="stylesheet" type="text/css" href="css/app.css" media="screen" />

	<!-- SAGE2 code -->
	<script async src="src/md5.js"></script>
	<script async src="src/websocket.io.js"></script>
	<script async src="src/SAGE2_runtime.js"></script>
	<script async src="src/SAGE2_interaction.js"></script>

	<script type="text/javascript" src="lib/webix/webix.js"></script>
	<link type="text/css" rel="stylesheet" href="lib/webix/skins/compact.css">


      <script type="text/javascript">
const remote   = require('electron').remote;
const Menu     = remote.Menu;
const MenuItem = remote.MenuItem;
const Tray     = remote.Tray;

// Tray
var appIcon = null;
appIcon = new Tray(__dirname + '/images/S2.png');
var trayMenu = Menu.buildFromTemplate([
	{ label: 'Screen sharing', type: 'checkbox', checked: false, click: sharing_func },
	{ label: 'Quit', type: 'normal', role: 'quit' }
]);
appIcon.setHighlightMode(false);
appIcon.setToolTip('SAGE2');
appIcon.setContextMenu(trayMenu);

/**
 * Function for the Tray icon, to start/stop screen sharing
 *
 * @method     sharing_func
 * @param      {<type>}  menuitem  The menuitem
 * @param      {<type>}  win       The window
 * @param      {<type>}  event     The event
 */
function sharing_func(menuitem, win, event) {
	if (menuitem.checked) {
		sharescreen_func();
	} else {
		stopsharing_func();
	}
}


var template = [{
	label: 'Edit',
	submenu: [{
		label: 'Share Screen',
		click: function() {
			// start/stop screen sharing
			sharescreen_func();
		}
	}, {
		type: 'separator'
	}, {
		label: 'Cut',
		accelerator: 'CmdOrCtrl+X',
		role: 'cut'
	}, {
		label: 'Copy',
		accelerator: 'CmdOrCtrl+C',
		role: 'copy'
	}, {
		label: 'Paste',
		accelerator: 'CmdOrCtrl+V',
		role: 'paste'
	}]
	}, {
		label: 'View',
		submenu: [
			{role: 'reload'},
			{role: 'forcereload'},
			{role: 'toggledevtools'},
			{type: 'separator'},
			{role: 'resetzoom'},
			{role: 'zoomin'},
			{role: 'zoomout'},
			{type: 'separator'},
			{role: 'togglefullscreen'}
		]
	}, {
		role: 'window',
		submenu: [
			{role: 'minimize'}
		]
	}, {
		role: 'help',
		submenu: [{
			label: 'Learn More',
			click () { require('electron').shell.openExternal('http://sage2.sagecommons.org/') }
		}]
	}
];

if (process.platform == 'darwin') {
	var name = require('electron').remote.app.getName();
	template.unshift({
		label: name,
		submenu: [{
			label: 'About ' + name,
			role: 'about'
		}, {
			label: 'Hide ' + name,
			accelerator: 'Command+H',
			role: 'hide'
		}, {
			label: 'Hide Others',
			accelerator: 'Command+Alt+H',
			role: 'hideothers'
		}, {
			label: 'Show All',
			role: 'unhide'
		}, {
			type: 'separator'
		}, {
			label: 'Quit',
			accelerator: 'Command+Q',
			click: function() {
				stopsharing_func();
				require('electron').remote.app.quit();
			}
		}]
	});
}
const menu = Menu.buildFromTemplate(template)
Menu.setApplicationMenu(menu)

// SAGE2 code
var wsio;
var interactor;

navigator.getUserMedia = (navigator.getUserMedia  || navigator.webkitGetUserMedia ||
  navigator.mozGetUserMedia || navigator.msGetUserMedia);

var show_browser = true;
var save_width   = 1200;
var hasMouse     = true;

// Explicitely close web socket when web browser is closed
window.onbeforeunload = function() {
	if (appIcon) {
		appIcon.destroy();
	}
	// stop screen sharing
	stopsharing_func();
};

/**
 * When the page loads, everything starts
 *
 */
window.addEventListener('load', function(event) {
	webix.ready(function () {
		SAGE2_init();
	});
});

function fileUploadStart(files) {
}
function fileUploadProgress(percent) {
}
function fileUploadComplete() {
}

function isValidURL(str) {
	var pattern1 = new RegExp('^(https?:\\/\\/)');
	var pattern2 = new RegExp('^(http?:\\/\\/)');
	return pattern1.test(str) || pattern2.test(str);
}
function isValidWebsocket(str) {
	var pattern1 = new RegExp('^(wss?:\\/\\/)');
	var pattern2 = new RegExp('^(ws?:\\/\\/)');
	return pattern1.test(str) || pattern2.test(str);
}
function isValidSecureWebsocket(str) {
	var pattern1 = new RegExp('^(wss?:\\/\\/)');
	return pattern1.test(str);
}

/**
 * Get geolocation from thebrowser if possible (google API key put in the electron process)
 *
 * @method     geoLocation
 */
function geoLocation() {
	let location;
	if ("geolocation" in navigator) {
		console.log('Geo> Location services available')
		navigator.geolocation.getCurrentPosition(function(position) {
			location = {
				lat: position.coords.latitude,
				lng: position.coords.longitude
			}
			console.log('Geo> got location', location);
		}, function (err) {
			console.warn('Geo> user geolocation error:', err.message, err.code);
		}, {
			enableHighAccuracy: true, // high-precision
			timeout: 5000,  // 5 sec. maximum
			maximumAge: 0   // get a fresh value
		});
	} else {
		console.warn('Geo> geolocation services unvailable in this browser');		
	}
}



/**
 * Entry point of the user interface
 *
 * @method SAGE2_init
 */
function SAGE2_init() {
	console.log('SAGE2 Init');

	// Get location of the user
	geoLocation();

	var menu = [
		{ value: "Home"},
		{ value: "Messages"},
		{ value: "Settings",  submenu: ["Edit Name", "Change Password", "Alerts"] }
	];
  
	var mainUI = webix.ui({
		"id": "mainUI",
		"container": "wrapper",
		id: "column1",
		width: 300,
		rows : [
		{
			cols : [
				{
					label: "Server", view: "text",
					id: "sage2_id",
					placeholder: "hostname[:secure_port]",
					// value: "localhost:9090"
				}
			]
		},
		{
			cols : [
				{
					label: "Passcode", view: "text",
					type:'password',
					id: "passcode_id",
					placeholder: "Optional access code"
				}
			]
		},
		{
			cols : [
				{
					value: "Connect", view: "button",
					id: "connect_id",
					click: connect_func,
				}
			]
		},
		{
			cols : [
				{
					value: "Share your screen", view: "button",
					id: "sharescreen_id",
					click: sharescreen_func,
				}
			]
		},
		{
			value: "Show pointer", view: "button",
			id: "pointer_id",
			click: startpointer_func,						
		},
		{
			template: '<img height=100% style="display:block;margin-left:auto;margin-right:auto"' + 
				'src="images/S2-logo.png"/>',
			height: 170,
		}
		]
	});

	// When all UI ready
	webix.promise.all([]).then(function() {
		// Attach handlers for keyboard
		$$("sage2_id").attachEvent("onKeyPress", function(code, e) {
			// ENTER activates
			if (code === 13) {
				connect_func();
			}
		});
		$$("passcode_id").attachEvent("onKeyPress", function(code, e) {
			// ENTER activates
			if (code === 13) {
				connect_func();
			}
		});
		// set the URL fox the default focus
		$$("sage2_id").focus();
	});
}

function showMessage(msg) {
	webix.alert({
		type: "alert-warning",
		title: "SAGE2™",
		ok: "OK",
		text: msg
	});
}

function connect_func() {
	if (wsio) {
		wsio.close();
		if (interactor) {
			interactor.stopSAGE2Pointer();
			interactor.removeListeners();
			delete interactor;
		}
		delete wsio;

		var pbutton = $$('connect_id').$view.querySelector('button');
		pbutton.style.backgroundColor = "#3498db";
		pbutton.innerText = "Connect";
	}

	var aurl  = $$('sage2_id').getValue();
	var pcode = $$('passcode_id').getValue();
	var surl;

	if (!aurl) {
		return;
	}

	if (isValidSecureWebsocket(aurl)) {
		surl = aurl;
	} else {
		if (!isValidURL(aurl)) {
			aurl = 'https://' + aurl;
		}
		var parsedURL = new URL(aurl);
		if (parsedURL.host) {
			aurl = parsedURL.host;
		} else {
			aurl = parsedURL.href;
		}
		surl = "wss://" + aurl;
		// update the UI
		$$('sage2_id').setValue(aurl);
	}

	console.log('Connecting to', surl, pcode);

	// Detect which browser is being used
	SAGE2_browser();

	// Create a connection to the SAGE2 server
	wsio = new WebsocketIO(surl);
	// socket close event (i.e. server crashed)
	wsio.on('close', function(evt) {
		showMessage("Connection closed");

		var pbutton = $$('connect_id').$view.querySelector('button');
		pbutton.style.backgroundColor = "#3498db";
		pbutton.innerText = "Connect";
	});
	wsio.open(function() {
		console.log("Websocket opened");

		setupListeners();

		var clientDescription = {
			clientType: "sageUI",
			requests: {
				config:  true,
				version: true,
				time:    false,
				console: false
			},
			browser: __SAGE2__.browser,
			session: pcode ? md5(pcode) : null
		};
		wsio.emit('addClient', clientDescription);

		// Interaction object: file upload, desktop sharing, ...
		interactor = new SAGE2_interaction(wsio);
		interactor.setFileUploadStartCallback(fileUploadStart);
		interactor.setFileUploadProgressCallback(fileUploadProgress);
		interactor.setFileUploadCompleteCallback(fileUploadComplete);
	});
}

function sharescreen_func() {
	if (interactor && interactor.broadcasting) {
		stopsharing_func();
	} else if (interactor && !interactor.broadcasting) {
			// start the sharing
			interactor.captureDesktop("screen");
			// update the button
			var pbutton = $$('sharescreen_id').$view.querySelector('button');
			pbutton.style.backgroundColor = "#00b359";
			pbutton.innerText = "Sharing...";
			// update tray item
			trayMenu.items[0].checked = true;
	} else {
		showMessage("Connect to server first");
		// update tray item
		trayMenu.items[0].checked = false;
	}
}

function stopsharing_func() {
	if (interactor && interactor.mediaStream !== null) {
		var track = interactor.mediaStream.getTracks()[0];
		track.stop();
		// update tray item
		trayMenu.items[0].checked = false;
		// update button
		// update the button
		var pbutton = $$('sharescreen_id').$view.querySelector('button');
		pbutton.style.backgroundColor = "#3498db";
		pbutton.innerText = "Share your screen";
	}
}

function startpointer_func() {
	if (interactor && !interactor.pointering) {
		interactor.startSAGE2Pointer($$('pointer_id').$view.querySelector('button'));
	}
}

function pointerClick(event) {
	console.log('Click')
}

function setupListeners() {
	wsio.on('initialize', function(data) {
		console.log('initialize', data);
		interactor.setInteractionId(data.UID);

		// Update button color and label
		var pbutton = $$('connect_id').$view.querySelector('button');
		pbutton.style.backgroundColor = "#00b359";
		pbutton.innerText = "Connected";
	});


	// Open a popup on message sent from server
	wsio.on('errorMessage', function(data) {
		console.log('message from server>', data);
	});

	wsio.on('setupDisplayConfiguration', function(config) {
		console.log('Display', config);

		var sage2Min  = Math.min(config.totalWidth, config.totalHeight);
		var screenMin = Math.min(screen.width, screen.height);
		interactor.setPointerSensitivity(sage2Min / screenMin);
	});

	// Server sends the SAGE2 version
	wsio.on('setupSAGE2Version', function(data) {
		console.log('SAGE2: version', data.base, data.branch, data.commit, data.date);
	});

	wsio.on('requestNextFrame', function(data) {
		interactor.requestMediaStreamFrame();
	});

	wsio.on('stopMediaCapture', function() {
		if (interactor.mediaStream !== null) {
			var track = interactor.mediaStream.getTracks()[0];
			track.stop();
		}
	});

	wsio.on('createAppWindowPositionSizeOnly', function() {
		// pass
	});
}

      </script>
  </head>
  <body>

	<div style="width:300px;background-color:#FFFFFF;">
		<div id="wrapper" style="background-color: #ececec;">
		</div>
	</div>

	<canvas id="mediaCanvas" style="display: none;"></canvas>
	<video  id="mediaVideo"  style="display: none;"></video>


  </body>
</html>
