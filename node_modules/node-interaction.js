var MODE = {WINDOW_MANAGEMENT: 0, APP_INTERACTION: 1};

function interaction() {
	this.selectedMoveItem = null;
	this.selectedScrollItem = null;
	this.selectedResizeItem = null;
	this.hoverCornerItem = null;
	this.selectOffsetX = 0;
	this.selectOffsetY = 0;
	this.selectTimeId = {};
	this.interactionMode = MODE.WINDOW_MANAGEMENT;
	
	this.CTRL = false;
	this.SHIFT = false;
	this.ALT = false;
	this.CMD = false;
	this.CAPS = false;
}

interaction.prototype.selectMoveItem = function(moveItem, pointerX, pointerY) {
	if(this.interactionMode != MODE.WINDOW_MANAGEMENT) return;
	this.selectedMoveItem = moveItem;
	this.selectedScrollItem = null;
	this.selectedResizeItem = null;
	this.selectOffsetX = this.selectedMoveItem.left - pointerX;
	this.selectOffsetY = this.selectedMoveItem.top - pointerY;
};

interaction.prototype.selectScrollItem = function(scrollItem) {
	if(this.interactionMode != MODE.WINDOW_MANAGEMENT) return;
	
	this.selectedMoveItem = null;
	this.selectedScrollItem = scrollItem;
	this.selectedResizeItem = null;
};

interaction.prototype.releaseItem = function() {
	if(this.interactionMode != MODE.WINDOW_MANAGEMENT) return;
	
	this.selectedMoveItem = null;
	this.selectedScrollItem = null;
	this.selectedResizeItem = null;
};

interaction.prototype.moveSelectedItem = function(pointerX, pointerY) {
	if(this.interactionMode != MODE.WINDOW_MANAGEMENT) return null;
	if(this.selectedMoveItem == null) return null;
	
	this.selectedMoveItem.left = pointerX + this.selectOffsetX;
	this.selectedMoveItem.top = pointerY + this.selectOffsetY;
	this.selectedMoveItem.isMaximized = 0;

	return {elemId: this.selectedMoveItem.id, elemLeft: this.selectedMoveItem.left, elemTop: this.selectedMoveItem.top, elemWidth: this.selectedMoveItem.width, elemHeight: this.selectedMoveItem.height, date: new Date()};
};

interaction.prototype.scrollSelectedItem = function(scale) {
	if(this.interactionMode != MODE.WINDOW_MANAGEMENT) return null;
	if(this.selectedScrollItem == null) return null;
	
	var iWidth = this.selectedScrollItem.width * scale;
	var iHeight = iWidth / this.selectedScrollItem.aspect;
	if(iWidth < 40){
		iWidth = 40;
		iHeight = iWidth / this.selectedScrollItem.aspect;
	}
	if(iHeight < 40){
		iHeight = 40;
		iWidth = iHeight * this.selectedScrollItem.aspect;
	}
	var iCenterX = this.selectedScrollItem.left + (this.selectedScrollItem.width/2);
	var iCenterY = this.selectedScrollItem.top + (this.selectedScrollItem.height/2);
	
	this.selectedScrollItem.left = iCenterX - (iWidth/2);
	this.selectedScrollItem.top = iCenterY - (iHeight/2);
	this.selectedScrollItem.width = iWidth;
	this.selectedScrollItem.height = iHeight;
	
	this.selectedScrollItem.isMaximized = 0;

	return {elemId: this.selectedScrollItem.id, elemLeft: this.selectedScrollItem.left, elemTop: this.selectedScrollItem.top, elemWidth: this.selectedScrollItem.width, elemHeight: this.selectedScrollItem.height, date: new Date()};
};

interaction.prototype.setHoverCornerItem = function(item) {
	this.hoverCornerItem = item;
}

interaction.prototype.selectResizeItem = function(resizeItem, pointerX, pointerY) {
	if(this.interactionMode != MODE.WINDOW_MANAGEMENT) return;
	
	this.selectedMoveItem = null;
	this.selectedScrollItem = null;
	this.selectedResizeItem = resizeItem;
	this.selectOffsetX = this.selectedResizeItem.width - (pointerX - this.selectedResizeItem.left);
	this.selectOffsetY = this.selectedResizeItem.height - (pointerY - this.selectedResizeItem.top);
}

interaction.prototype.resizeSelectedItem = function(pointerX, pointerY) {
	if(this.interactionMode != MODE.WINDOW_MANAGEMENT) return null;
	if(this.selectedResizeItem == null) return null;
	
	var iWidth = pointerX - this.selectedResizeItem.left + this.selectOffsetX;
	var iHeight = iWidth / this.selectedResizeItem.aspect;
	// var iHeight = pointerY - this.selectedResizeItem.top + this.selectOffsetY; // correct - but does not preserve aspect ratio
	if(iWidth < 40){
		iWidth = 40;
		iHeight = iWidth / this.selectedResizeItem.aspect;
	}
	if(iHeight < 40){
		iHeight = 40;
		iWidth = iHeight * this.selectedResizeItem.aspect;
	}
	
	this.selectedResizeItem.width = iWidth;
	this.selectedResizeItem.height = iHeight;
	this.selectedResizeItem.isMaximized = 0;

	return {elemId: this.selectedResizeItem.id, elemLeft: this.selectedResizeItem.left, elemTop: this.selectedResizeItem.top, elemWidth: this.selectedResizeItem.width, elemHeight: this.selectedResizeItem.height, date: new Date()};
};

interaction.prototype.maximizeSelectedItem = function(item, config) {
	if(this.interactionMode != MODE.WINDOW_MANAGEMENT) return null;
	if(item == null) return null;
	
	var wallRatio = config.totalWidth / config.totalHeight;
	var iCenterX  = config.totalWidth/2.0;
	var iCenterY  = config.totalHeight/2.0;
	var iWidth    = 0;
	var iHeight   = 0;
	if (item.aspect > wallRatio) {
		// Image wider than wall
		iWidth  = config.totalWidth - (3*config.titleBarHeight);
		iHeight = iWidth / item.aspect;
	} else {
		// Wall wider than image
		iHeight = config.totalHeight - (3*config.titleBarHeight);
		iWidth  = iHeight*item.aspect;
	}
	// back up values for retore
	item.previous_left   = item.left;
	item.previous_top    = item.top;
	item.previous_width  = item.width;
	item.previous_height = item.height;	

	// calculate new values
	item.left   = iCenterX - (iWidth/2);
	item.top    = iCenterY - (iHeight/2);
	item.width  = iWidth;
	item.height = iHeight;
	
	item.isMaximized = 1;

	return {elemId: item.id, elemLeft: item.left, elemTop: item.top, elemWidth: item.width, elemHeight: item.height, date: new Date()};
};

interaction.prototype.restoreSelectedItem = function(item) {
	if(this.interactionMode != MODE.WINDOW_MANAGEMENT) return null;
	if(item == null) return null;
	
	item.left   = item.previous_left;
	item.top    = item.previous_top;
	item.width  = item.previous_width;
	item.height = item.previous_height;
	
	item.isMaximized = 0;

	return {elemId: item.id, elemLeft: item.left, elemTop: item.top, elemWidth: item.width, elemHeight: item.height, date: new Date()};
};


interaction.prototype.isWindowManagementMode = function() {
	return this.interactionMode == MODE.WINDOW_MANAGEMENT;
};

interaction.prototype.isAppInteractionMode = function() {
	return this.interactionMode == MODE.APP_INTERACTION;
};

interaction.prototype.selectWindowManagementMode = function() {
	this.interactionMode = MODE.WINDOW_MANAGEMENT;
	
	this.selectedMoveItem = null;
	this.selectedScrollItem = null;
	this.selectedResizeItem = null;
};

interaction.prototype.selectAppInteractionMode = function() {
	this.interactionMode = MODE.APP_INTERACTION;
	console.log("interaction: " + this.interactionMode);
	
	this.selectedMoveItem = null;
	this.selectedScrollItem = null;
	this.selectedResizeItem = null;
};

interaction.prototype.toggleModes = function(){
    if( this.interactionMode == MODE.WINDOW_MANAGEMENT )
        this.interactionMode = MODE.APP_INTERACTION; 
    else if( this.interactionMode ==  MODE.APP_INTERACTION )
        this.interactionMode = MODE.WINDOW_MANAGEMENT;
    
    this.selectedMoveItem = null;
	this.selectedScrollItem = null;
	this.selectedResizeItem = null;
};

interaction.prototype.windowManagementMode = function(){
    return this.interactionMode == MODE.WINDOW_MANAGEMENT;
};

interaction.prototype.appInteractionMode = function(){
    return this.interactionMode == MODE.APP_INTERACTION;
};

module.exports = interaction;
