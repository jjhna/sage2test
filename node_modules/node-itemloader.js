var decompresszip = require('decompress-zip');
var ffprobe = require('node-ffprobe');
var fs = require('fs');
var imageinfo = require('imageinfo');
var path = require('path');
var request = require('request');
var url = require('url');
var ytdl = require('ytdl');

var pdfinfo = require('node-pdfinfo').pdfinfo;     // custom node module

/*
module.exports.loadImage = function(img_data, external_url, id, title, callback) {
	var info = imageinfo(img_data);
	var source = "data:" + info.mimeType + ";base64, " + img_data.toString("base64");
	var aspect = info.width / info.height;
	var now = new Date();

	callback(new item("img", title, id, source, external_url, 0, 0, info.width, info.height, aspect, now, null, null));
};

module.exports.loadVideo = function(vid_path, vid_url, external_url, id, title, callback) {
	ffprobe(vid_path, function(err, data){
		if(err) throw err;

		for(var i=0; i<data.streams.length; i++){
			if(data.streams[i].codec_type == "video"){
				var aspect = data.streams[i].width / data.streams[i].height;
				var now = new Date();

				callback(new item("video", title, id, vid_url, external_url, 0, 0, data.streams[i].width, data.streams[i].height, aspect, now, null, null));
			}
		}
	});
};

module.exports.loadYoutube = function(yt_url, id, callback) {
	ytdl.getInfo(yt_url, function(err, info){
		if(err) throw err;

		var mp4 = {index: -1, resolution: 0};
		for(var i=0; i<info.formats.length; i++){
			if(info.formats[i].container == "mp4" && info.formats[i].resolution !== null && info.formats[i].profile != "3d"){
				var res = parseInt(info.formats[i].resolution.substring(0, info.formats[i].resolution.length-1));
				if(res > mp4.resolution){
					mp4.index = i;
					mp4.resolution = res;
				}
			}
		}

		var title = info.title;
		var aspect = 16/9;
		var resolutionY = mp4.resolution;
		var resolutionX = resolutionY * aspect;
		var poster = info.iurlmaxres;
		if (poster === null) poster = info.iurl;
		if (poster === null) poster = info.iurlsd;
		var now = new Date();

		callback(new item("youtube", title, id, info.formats[mp4.index].url, yt_url, 0, 0, resolutionX, resolutionY, aspect, now, poster, null));
	});
};

module.exports.loadPdf = function(pdf_path, pdf_url, external_url, id, title, callback) {
	pdfinfo(pdf_path, function(err, doc) {
		if(err) throw err;

		var aspect = doc.page_width/doc.page_height;
		var now = new Date();

		callback(new item("pdf", title, id, pdf_url, external_url, 0, 0, doc.page_width, doc.page_height, aspect, now, null, null));
	});
};

module.exports.loadApp = function(zip_path, zip_url, external_url, id, callback) {
	var zipName = path.basename(zip_path);
	var zipFolder = zip_path;

	var instuctionsFile = path.join(zipFolder, "instructions.json");
	fs.readFile(instuctionsFile, 'utf8', function(err, json_str) {
		if(err) throw err;

		var instructions = JSON.parse(json_str);
		var objName = instructions.main_script.substring(0, instructions.main_script.lastIndexOf('.'));
		var aspect = instructions.width / instructions.height;
		var now = new Date();
		
		callback(new item(instructions.type, zipName, id, path.join(zip_url, instructions.main_script), external_url, 0, 0, instructions.width, instructions.height, aspect, now, zip_url+path.sep, objName), instructions);
	});
};

module.exports.loadRemoteApp = function(zip_url, id, callback) {
	var zipName = path.basename(decodeURIComponent(url.parse(zip_url).pathname));
	var zipFolder = zip_url;
	
	var instuctionsFile = zipFolder + "/instructions.json";
	request({url: instuctionsFile, encoding: null, strictSSL: false}, function(err, response, body) {
		if(err) throw err;
		
		var instructions = JSON.parse(body);
		var objName = instructions.main_script.substring(0, instructions.main_script.lastIndexOf('.'));
		var aspect = instructions.width / instructions.height;
		var now = new Date();
		
		callback(new item(instructions.type, zipName, id, zip_url+"/"+instructions.main_script, zip_url, 0, 0, instructions.width, instructions.height, aspect, now, zip_url+"/", objName), instructions);
	});
};

module.exports.loadZipApp = function(zip_path, zip_url, external_url, id, callback) {
	var zipName = path.basename(zip_path, path.extname(zip_path));
	var zipFolder = path.join(path.dirname(zip_path), zipName);

	var unzipper = new decompresszip(zip_path);
	unzipper.on('extract', function(log) {
		// read instructions for how to handle
		var instuctionsFile = path.join(zipFolder, "instructions.json");
		fs.readFile(instuctionsFile, 'utf8', function(err, json_str) {
			if(err) throw err;

			var instructions = JSON.parse(json_str);
			var objName = instructions.main_script.substring(0, instructions.main_script.lastIndexOf('.'));
			var aspect = instructions.width / instructions.height;
			var now = new Date();
			
			callback(new item(instructions.type, zipName, id, path.join(zip_url, instructions.main_script), external_url, 0, 0, instructions.width, instructions.height, aspect, now, zip_url+path.sep, objName), instructions);
		});

		// delete original zip file
		fs.unlink(zip_path, function(err) {
			if(err) throw err;
		});
	});
	unzipper.extract({
		path: path.dirname(zip_path),
		filter: function(file) {
			if(file.type === "SymbolicLink") return false;
			if(file.filename === "__MACOSX") return false;
			if(file.filename.substring(0,1) == ".") return false;
			if(file.parent.length >= 8 && file.parent.substring(0,8) == "__MACOSX") return false;

			return true;
		}
	});
};

module.exports.loadScreenCapture = function(img_data, id, title, width, height, callback) {
	var aspect = width/height;
	var now = new Date();
	callback(new item("screen", title, id, img_data, null, 0, 0, width, height, aspect, now, null, null));
};

module.exports.loadRemoteScreen = function(img_data, id, title, callback) {
	var buf = new Buffer(img_data, 'binary');

	var info = imageinfo(buf);
	var aspect = info.width / info.height;
	var now = new Date();
	callback(new item("remote_screen", title, id, img_data, null, 0, 0, info.width, info.height, aspect, now, null, null));
};

module.exports.loadWebpage = function(img_data, id, title, width, height, callback) {
	var aspect = width/height;
	var now = new Date();
	callback(new item("webpage", title, id, img_data, null, 0, 0, width, height, aspect, now, null, null));
};
*/


//////////////////////////////////////////////////////////////////////////////////////////
function appLoader(publicDir, hostOrigin) {
	this.publicDir = publicDir;
	this.hostOrigin = hostOrigin;
	this.mime2app = {
		"image/jpeg": "image_viewer", 
        "image/png": "image_viewer", 
        "video/mp4": "movie_player", 
        "video/youtube": "movie_player",
        "application/pdf": "pdf_viewer", 
        "application/zip": "custom_app",
        "application/x-zip-compressed": "custom_app"
    };
    this.app2dir = {
    	"image_viewer": "images",
    	"movie_player": "videos",
    	"pdf_viewer": "pdfs",
    	"custom_app": "apps"
    };
}

appLoader.prototype.loadImageFromURL = function(url, name, strictSSL, callback) {
	// Add "strictSSL: false" to request to ignore unknown SSL certificates
	console.log("strictSSL: " + strictSSL);
	request({url: url, encoding: null, strictSSL: strictSSL}, function(err, response, body) {
		if(err) throw err;
		
		var info = imageinfo(body);
		var source = body.toString("base64");
		var aspectRatio = info.width / info.height;
		
		var appInstance = {
			id: null,
			title: name,
			application: "image_viewer",
			url: url,
			data: {
				src: source,
				type: info.mimeType
			},
			resrc: null,
			left: 0,
			top: 0,
			width: info.width,
			height: info.height,
			aspect: aspectRatio,
			animation: false,
			date: new Date()
		};
		callback(appInstance);
	});
};

appLoader.prototype.loadYoutubeFromURL = function(url, callback) {
	var _this = this;
	
	ytdl.getInfo(url, function(err, info){
		if(err) throw err;
		
		var mp4 = {index: -1, resolution: 0};
		for(var i=0; i<info.formats.length; i++){
			if(info.formats[i].container == "mp4" && info.formats[i].resolution !== null && info.formats[i].profile != "3d"){
				var res = parseInt(info.formats[i].resolution.substring(0, info.formats[i].resolution.length-1));
				if(res > mp4.resolution){
					mp4.index = i;
					mp4.resolution = res;
				}
			}
		}

		var name = info.title;
		var aspectRatio = 16/9;
		var resolutionY = mp4.resolution;
		var resolutionX = resolutionY * aspectRatio;
		
		/*
		var poster = info.iurlmaxres;
		if (poster === null) poster = info.iurl;
		if (poster === null) poster = info.iurlsd;
		*/
		
		_this.loadVideoFromURL(info.formats[mp4.index].url, name, function(appInstance) {
			callback(appInstance);
		});
	});
};

appLoader.prototype.loadVideoFromURL = function(url, name, callback) {
	ffprobe(url, function(err, data){
		if(err) throw err;
		
		var i;
		for(i=0; i<data.streams.length; i++){
			if(data.streams[i].codec_type == "video"){
				var aspectRatio = data.streams[i].width / data.streams[i].height;
				
				var appInstance = {
					id: null,
					title: name,
					application: "movie_player",
					url: url,
					data: {
						src: url,
						type: "video/mp4",
						play: false,
						time: 0.0
					},
					resrc: null,
					left: 0,
					top: 0,
					width: data.streams[i].width,
					height: data.streams[i].height,
					aspect: aspectRatio,
					animation: false,
					date: new Date()
				};
				callback(appInstance);
				return;
			}
		}
	});
};

appLoader.prototype.loadPdfFromURL = function(url, name, strictSSL, callback) {
	var local_url = path.join("uploads", "pdfs", name);
	var localPath = path.join(this.publicDir, local_url);
	var _this = this;
	
	var tmp = fs.createWriteStream(localPath);
	tmp.on('error', function(err) {
		if(err) throw err;
	});
	tmp.on('close', function() {
		//loadPDF
		_this.loadPdfFromFile(localPath, local_url, url, name, function(appInstance) {
			callback(appInstance);
		});
	});
	// Add "strictSSL: false" to request to ignore unknown SSL certificates
	request({url: url, strictSSL: strictSSL}).pipe(tmp);
};



appLoader.prototype.loadImageFromFile = function(file, url, external_url, name, callback) {
	fs.readFile(file, function (err, data) {
		if(err) throw err;
		
		var info = imageinfo(data);
		var source = data.toString("base64");
		var aspectRatio = info.width / info.height;
		
		var appInstance = {
			id: null,
			title: name,
			application: "image_viewer",
			url: external_url,
			data: {
				src: source,
				type: info.mimeType
			},
			resrc: null,
			left: 0,
			top: 0,
			width: info.width,
			height: info.height,
			aspect: aspectRatio,
			animation: false,
			date: new Date()
		};
		callback(appInstance);
	});
};

appLoader.prototype.loadVideoFromFile = function(file, url, external_url, name, callback) {
	ffprobe(file, function(err, data){
		if(err) throw err;
		
		var i;
		for(i=0; i<data.streams.length; i++){
			if(data.streams[i].codec_type == "video"){
				var aspectRatio = data.streams[i].width / data.streams[i].height;
				
				var appInstance = {
					id: null,
					title: name,
					application: "movie_player",
					url: external_url,
					data: {
						src: url,
						type: "video/mp4",
						play: false,
						time: 0.0
					},
					resrc: null,
					left: 0,
					top: 0,
					width: data.streams[i].width,
					height: data.streams[i].height,
					aspect: aspectRatio,
					animation: false,
					date: new Date()
				};
				callback(appInstance);
				return;
			}
		}
	});
};

appLoader.prototype.loadPdfFromFile = function(file, url, external_url, name, callback) {
	pdfinfo(file, function(err, doc) {
		if(err) throw err;

		var aspectRatio = doc.page_width/doc.page_height;
		
		var appInstance = {
			id: null,
			title: name,
			application: "pdf_viewer",
			url: external_url,
			data: {
				src: url,
				type: "application/pdf",
				page: 1,
				numPagesShown: 1
			},
			resrc: null,
			left: 0,
			top: 0,
			width: doc.page_width,
			height: doc.page_height,
			aspect: aspectRatio,
			animation: false,
			date: new Date()
		};
		callback(appInstance);
	});
};

appLoader.prototype.loadAppFromFile = function(file, url, external_url, name, callback) {
	var zipFolder = file;

	var instuctionsFile = path.join(zipFolder, "instructions.json");
	fs.readFile(instuctionsFile, 'utf8', function(err, json_str) {
		if(err) throw err;

		var instructions = JSON.parse(json_str);
		var appName = instructions.main_script.substring(0, instructions.main_script.lastIndexOf('.'));
		var aspectRatio = instructions.width / instructions.height;
		
		var appInstance = {
			id: null,
			title: name,
			application: appName,
			url: external_url,
			data: instructions.load,
			resrc: url,
			left: 0,
			top: 0,
			width: instructions.width,
			height: instructions.height,
			aspect: aspectRatio,
			animation: instructions.animation,
			date: new Date()
		};
		
		callback(appInstance);
	});
};

appLoader.prototype.loadZipAppFromFile = function(file, url, external_url, name, callback) {
	var zipFolder = path.join(path.dirname(file), name);

	var unzipper = new decompresszip(file);
	unzipper.on('extract', function(log) {
		// read instructions for how to handle
		var instuctionsFile = path.join(zipFolder, "instructions.json");
		fs.readFile(instuctionsFile, 'utf8', function(err, json_str) {
			if(err) throw err;

			var instructions = JSON.parse(json_str);
			var appName = instructions.main_script.substring(0, instructions.main_script.lastIndexOf('.'));
			var aspectRatio = instructions.width / instructions.height;
			
			var appInstance = {
				id: null,
				title: name,
				application: appName,
				url: external_url,
				data: instructions.load,
				resrc: url,
				left: 0,
				top: 0,
				width: instructions.width,
				height: instructions.height,
				aspect: aspectRatio,
				animation: instructions.animation,
				date: new Date()
			};
			
			callback(appInstance);
		});

		// delete original zip file
		fs.unlink(file, function(err) {
			if(err) throw err;
		});
	});
	unzipper.extract({
		path: path.dirname(file),
		filter: function(extractedFile) {
			if(extractedFile.type === "SymbolicLink") return false;
			if(extractedFile.filename === "__MACOSX") return false;
			if(extractedFile.filename.substring(0,1) === ".") return false;
			if(extractedFile.parent.length >= 8 && extractedFile.parent.substring(0,8) === "__MACOSX") return false;

			return true;
		}
	});
};

appLoader.prototype.createMediaStream = function(source, type, encoding, name, width, height, callback) {
	var aspectRatio = width/height;
	
	var appInstance = {
		id: null,
		title: name,
		application: "media_stream",
		url: null,
		data: {
			src: source,
			type: type,
			encoding: encoding
		},
		resrc: null,
		left: 0,
		top: 0,
		width: width,
		height: height,
		aspect: aspectRatio,
		animation: false,
		date: new Date()
	};
	callback(appInstance);
};

appLoader.prototype.loadFileFromWebURL = function(file, callback) {
	var mime_type = file.type || "unknown";
	var filename = decodeURI(file.url.substring(file.url.lastIndexOf("/")+1));
	var app = file.app || this.mime2app[mime_type];
	var strictSSL = file.strictSSL || true;
	
	if(app === "image_viewer"){
		this.loadImageFromURL(file.url, filename, strictSSL, function(appInstance) {
			callback(appInstance);
		});
	}
	else if(app === "movie_player"){
		if(mime_type === "video/youtube"){
			this.loadYoutubeFromURL(file.url, function(appInstance) {
				callback(appInstance);
			});
		}
		else{
			this.loadVideoFromURL(file.url, filename, function(appInstance) {
				callback(appInstance);
			});
		}
	}
	else if(app === "pdf_viewer"){
		this.loadPdfFromURL(file.url, filename, strictSSL, function(appInstance) {
			callback(appInstance);
		});
	}
};

appLoader.prototype.loadFileFromLocalStorage = function(file, callback) {
	var app = file.application;
	var dir = this.app2dir[app];
	
	var url = path.join("uploads", dir, file.filename);
	var external_url = this.hostOrigin + encodeURI(url);
	var localPath = path.join(this.publicDir, url);
	
	if(app === "image_viewer"){
		this.loadImageFromFile(localPath, url, external_url, file.filename, function(appInstance) {
			callback(appInstance);
		});
	}
	else if(app === "movie_player"){
		this.loadVideoFromFile(localPath, url, external_url, file.filename, function(appInstance) {
			callback(appInstance);
		});
	}
	else if(app === "pdf_viewer"){
		this.loadPdfFromFile(localPath, url, external_url, file.filename, function(appInstance) {
			callback(appInstance);
		});
	}
	else if(app === "custom_app"){
		this.loadAppFromFile(localPath, url, external_url, file.filename, function(appInstance) {
			callback(appInstance);
		});
	}
};

appLoader.prototype.manageAndLoadUploadedFile = function(file, callback) {
	var mime_type = file.headers['content-type'];
	var app = this.mime2app[mime_type];
	var dir = this.app2dir[app];
	
	var _this = this;
	var url = path.join("uploads", dir, file.originalFilename);
	var external_url = this.hostOrigin + encodeURI(url);
	var localPath = path.join(this.publicDir, url);
	
	fs.rename(file.path, localPath, function(err) {
		if(err) throw err;
	
		if(app === "image_viewer"){
			_this.loadImageFromFile(localPath, url, external_url, file.originalFilename, function(appInstance) {
				callback(appInstance);
			});
		}
		else if(app === "movie_player"){
			_this.loadVideoFromFile(localPath, url, external_url, file.originalFilename, function(appInstance) {
				callback(appInstance);
			});
		}
		else if(app === "pdf_viewer"){
			_this.loadPdfFromFile(localPath, url, external_url, file.originalFilename, function(appInstance) {
				callback(appInstance);
			});
		}
		else if(app === "custom_app"){
			var name = path.basename(file.originalFilename, path.extname(file.originalFilename));
			url = path.join("uploads", dir, name);
			external_url = this.hostOrigin + encodeURI(url);
			_this.loadZipAppFromFile(localPath, url, external_url, name, function(appInstance) {
				callback(appInstance);
			});
		}
	});
};

module.exports = appLoader;
//////////////////////////////////////////////////////////////////////////////////////////
