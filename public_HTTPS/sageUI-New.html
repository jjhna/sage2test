<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="utf-8">
<title>SAGE2 UI</title>
<!--<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">-->
<script type="text/javascript">
	// SAGE2 is available for use under the SAGE2 Software License 
	//      
	// University of Illinois at Chicago's Electronic Visualization Laboratory (EVL)
	// and University of Hawai'i at Manoa's Laboratory for Advanced Visualization and
	// Applications (LAVA)
	//      
	// See full text, terms and conditions in the LICENSE.txt included file
	//      
	// Copyright (c) 2014
</script>
<script type="text/javascript" src="src/websocket.io.js"></script>
<script type="text/javascript" src="src/SAGE2_interaction.js"></script>
<script type="text/javascript" src="src/SAGE2DisplayUI.js"></script>
<script type="text/javascript">
	window.URL = (window.URL || window.webkitURL || window.msURL || window.oURL);
	navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
	document.exitPointerLock = document.exitPointerLock || document.mozExitPointerLock || document.webkitExitPointerLock;
	
	var wsio;
	var displayUI;
	var interactor;
	var keyEvents;
	var touchMode;
	var touchDist;
	
	var selectedAppEntry;
	var selectedFileEntry;
	var type2App;
	
	function init() {
		hostname = window.location.hostname;
		port = window.location.port;
		if(window.location.protocol == "http:" && port == "") port = "80";
		if(window.location.protocol == "https:" && port == "") port = "443";
		
		wsio = new websocketIO(window.location.protocol, hostname, parseInt(port));
		wsio.open(function() {
			console.log("open websocket");
			interactor = new SAGE2_interaction(wsio);
			//window.postMessage('SAGE2_desktop_capture_enabled', "*");
			
			var clientDescription = {
				clientType: "sageUI",
				sendsPointerData: true,
				sendsMediaStreamFrames: true,
				requestsServerFiles: true,
				sendsWebContentToLoad: true,
				launchesWebBrowser: true,
				sendsVideoSynchonization: false,
				sharesContentWithRemoteServer: false,
				receivesDisplayConfiguration: true,
				receivesClockTime: false,
				requiresFullApps: false,
				requiresAppPositionSizeTypeOnly: true,
				receivesMediaStreamFrames: false,
				receivesWindowModification: true,
				receivesPointerData: false,
				receivesInputEvents: false,
				receivesRemoteServerInfo: false
			};
			wsio.emit('addClient', clientDescription);
		});
		
		// socket close event (i.e. server crashed)		
		wsio.on('close', function (evt) {
			var refresh = setInterval(function() {
				reloadIfServerRunning(function() {
					clearInterval(refresh);
				});
			}, 2000);
		});
		
		wsio.on('initialize', function(data) {
			interactor.setInteractionId(data.UID);
		});
		
		wsio.on('setupDisplayConfiguration', function(config) {
			displayUI = new SAGE2DisplayUI();
			displayUI.init(config, wsio);
			
			var sage2Min  = Math.min(config.totalWidth, config.totalHeight);
			var screenMin = Math.min(screen.width, screen.height);
			interactor.setPointerSensitivity(sage2Min/screenMin);
		});
		
		wsio.on('createAppWindowPositionSizeOnly', function(data) {
			displayUI.addAppWindow(data);
		});

		wsio.on('deleteElement', function(data) {
			displayUI.deleteApp(data.elemId);
		});
		
		wsio.on('updateItemOrder', function(data) {
			displayUI.updateItemOrder(data.idList);
		});
		
		wsio.on('setItemPosition', function(data) {
			displayUI.setItemPosition(data);
		});
		
		wsio.on('setItemPositionAndSize', function(data) {
			displayUI.setItemPositionAndSize(data);
		});
		
		wsio.on('availableApplications', function(data) {
			var appList = document.getElementById('appList');
			var appListContainer = document.getElementById('appListContainer');
			var size = parseInt(appListContainer.style.width, 10) / 6;
			
			removeAllChildren(appList);
			
			var i = 0;
			while(i < data.length){
				var row = document.createElement('tr');
				var appsPerRow = Math.min(data.length - i, 6);
				for(var j=0; j<appsPerRow; j++){
					var col = document.createElement('td');
					col.id = "app_row_" + data[i+j].exif.FileName;
					col.setAttribute("application", data[i+j].exif.FileName);
					col.style.verticalAlign = "top";
					col.style.textAlign = "center";
					col.style.width = size + "px";
					col.style.paddingTop = "12px";
					col.style.paddingBottom = "12px";
					var appIcon = document.createElement('img');
					appIcon.id = "app_icon_" + data[i+j].exif.FileName;
					appIcon.setAttribute("application", data[i+j].exif.FileName);
					appIcon.src = data[i+j].exif.SAGE2thumbnail+"_256.png";
					appIcon.width = parseInt(size * 0.8, 10);
					appIcon.height = parseInt(size * 0.8, 10);
					var appName = document.createElement('p');
					appName.id = "app_name_" + data[i+j].exif.FileName;
					appName.setAttribute("application", data[i+j].exif.FileName);
					appName.textContent = data[i+j].exif.metadata.title;
					col.appendChild(appIcon);
					col.appendChild(appName);
					row.appendChild(col);
				}
				appList.appendChild(row);
				i += appsPerRow;
			}
			
			showDialog('appLauncherDialog');
		});
		
		wsio.on('storedFileList', function(data) {
			document.getElementById('images-dir').checked   = false;
			document.getElementById('pdfs-dir').checked     = false;
			document.getElementById('videos-dir').checked   = false;
			document.getElementById('sessions-dir').checked = false;
			
			var images = document.getElementById('images');
			var videos = document.getElementById('videos');
			var pdfs = document.getElementById('pdfs');
			var sessions = document.getElementById('sessions');
			
			removeAllChildren(images);
			removeAllChildren(videos);
			removeAllChildren(pdfs);
			removeAllChildren(sessions);
			
			var longestImageName   = createFileList(data, "images",   images);
			var longestVideoName   = createFileList(data, "videos",   videos);
			var longestPdfName     = createFileList(data, "pdfs",     pdfs);
			var longestSessionName = createFileList(data, "sessions", sessions);
			
			var longest = Math.max(longestImageName, longestVideoName, longestPdfName, longestSessionName);
			document.getElementById('fileListElems').style.width = (longest+60).toString() + "px";
			
			showDialog('mediaBrowserDialog');
		});
		
		var sage2UI = document.getElementById('sage2UI');
		
		window.addEventListener('dragover', preventDefault, false);
		window.addEventListener('dragend',  preventDefault, false);
		window.addEventListener('drop',     preventDefault, false);
	
		sage2UI.addEventListener('dragover',  preventDefault, false);
		sage2UI.addEventListener('dragend',   preventDefault, false);
		sage2UI.addEventListener('dragenter', fileDragEnter,  false);
		sage2UI.addEventListener('dragleave', fileDragLeave,  false);
		sage2UI.addEventListener('drop',      fileDrop,       false);
		
		document.addEventListener('mousedown',  pointerPress, false);
		document.addEventListener('mouseup',    pointerRelease, false);
		document.addEventListener('mousemove',  pointerMove, false);
		document.addEventListener('click',      pointerClick, false);
		document.addEventListener('dblclick',   pointerDblClick, false);
		document.addEventListener('mousewheel', pointerScroll, false);
		document.addEventListener('touchstart', touchStart, false);
		document.addEventListener('touchend',   touchEnd, false);
		document.addEventListener('touchmove',  touchMove, false);
		
		keyEvents = false;
		selectedAppEntry = null;
		selectedFileEntry = null;
		
		type2App = {
			images: "image_viewer",
			videos: "movie_player",
			pdfs: "pdf_viewer",
			sessions: "load_session"
		};
		
		resizeDialogs();
	}
	
	function resize() {
		displayUI.resize();
		resizeDialogs();
	}
	
	function resizeDialogs() {
		var windowAspect = window.innerWidth/window.innerHeight;
		
		var appListContainer = document.getElementById('appListContainer');
		appListContainer.style.width = (window.innerWidth*0.7 - 24).toString() + "px";
		appListContainer.style.height = (window.innerHeight*0.7 - 48).toString() + "px";
		var fileListContainer = document.getElementById('fileListContainer');
		fileListContainer.style.width = (window.innerWidth/2 *0.6 - 24).toString() + "px";
		fileListContainer.style.height = (window.innerHeight/2 - 48).toString() + "px";
		var metadata = document.getElementById('metadata');
		metadata.style.left = (window.innerWidth/2 *0.6 - 13).toString() + "px";
		metadata.style.width = (window.innerWidth/2 *0.4).toString() + "px";
		metadata.style.height = (window.innerHeight/2 - 48).toString() + "px";
		var sage2pointerHelp = document.getElementById('sage2pointerHelp');
		var sage2pointerHelpAspect = 1264.25/982.255;
		if(sage2pointerHelpAspect <= windowAspect){
			sage2pointerHelp.height = window.innerHeight * 0.7;
			sage2pointerHelp.width = sage2pointerHelp.height * sage2pointerHelpAspect;
		}
		else {
			sage2pointerHelp.width = window.innerWidth * 0.7;
			sage2pointerHelp.height = sage2pointerHelp.width / sage2pointerHelpAspect;
		}
	}
	
	function createFileList(list, type, parent) {
		var textWidthTest = document.getElementById('textWidthTest');
		var longest = 0;
		for(var i=0; i<list[type].length; i++){
			var file = document.createElement('li');
			file.textContent = list[type][i].exif.FileName;
			file.id          = "file_" + list[type][i].exif.FileName;
			file.setAttribute("application", type2App[type]);
			file.setAttribute("file", list[type][i].exif.FileName);
			parent.appendChild(file);
			
			textWidthTest.textContent = file.textContent;
			var textWidth = (textWidthTest.clientWidth + 1);
			if(textWidth > longest) longest = textWidth;
		}
		textWidthTest.textContent = "";
		return longest;
	}
	
	function preventDefault(event) {
		event.preventDefault();
	}
	
	function fileDragEnter(event) {
		var sage2UI = document.getElementById('sage2UI');
		sage2UI.style.borderStyle = "dashed";
		displayUI.fileDrop = true;
		displayUI.draw();
	}
	
	function fileDragLeave(event) {
		var sage2UI = document.getElementById('sage2UI');
		sage2UI.style.borderStyle = "solid";
		displayUI.fileDrop = false;
		displayUI.draw();
	}
	
	function fileDrop(event) {
		event.preventDefault();
		
		// trigger file upload
		console.log("drop location: " + event.layerX + ", " + event.layerY);
		
		var sage2UI = document.getElementById('sage2UI');
		sage2UI.style.borderStyle = "solid";
		displayUI.fileDrop = false;
		displayUI.draw();
	}
	
	function pointerPress(event) {
		if(event.srcElement.id === "sage2UI"){
			var btn = (event.button === 0) ? "left" : (event.button === 1) ? "middle" : "right";
			displayUI.pointerPress(btn);
			event.preventDefault();
		}
	}
	
	function pointerRelease(event) {
		if(event.srcElement.id === "sage2UI"){
			var btn = (event.button === 0) ? "left" : (event.button === 1) ? "middle" : "right";
			displayUI.pointerRelease(btn);
			event.preventDefault();
		}
	}
	
	function pointerMove(event) {
		// listen for keyboard events if mouse moved over sage2UI
		if(event.srcElement.id === "sage2UI" && keyEvents === false){
			document.addEventListener('keydown',  keyDown,  false);
			document.addEventListener('keyup',    keyUp,    false);
            document.addEventListener('keypress', keyPress, false);
			keyEvents = true;
		}
		else if(event.srcElement.id !== "sage2UI" && keyEvents === true){
			document.removeEventListener('keydown',  keyDown,  false);
			document.removeEventListener('keyup',    keyUp,    false);
            document.removeEventListener('keypress', keyPress, false);
			keyEvents = false;
		}
		
		if(event.srcElement.id === "sage2UI"){
			var rect = event.srcElement.getBoundingClientRect();
			var mouseX = event.clientX - rect.left;
			var mouseY = event.clientY - rect.top;
			displayUI.pointerMove(mouseX, mouseY);
		}
	}
	
	function pointerClick(event) {
		var element = event.srcElement;
		
		// Menu Buttons
		if(element.id === "applauncher") {
			wsio.emit('requestAvailableApplications');
		}
		else if(element.id === "mediabrowser") {
			wsio.emit('requestStoredFiles');
		}
		else if(element.id === "arrangement") {
			showDialog('arrangementDialog');
		}
		else if(element.id === "settings") {
			showDialog('settingsDialog');
		}
		else if(element.id === "info") {
			
		}
		else if(element.id === "sharescreen") {
			
		}
		else if(element.id === "sage2pointer") {
			interactor.startSAGE2Pointer(element.id);
		}
		
		
		// App Launcher Dialog
		else if (element.id === "appOKBtn") {
			loadSelectedApplication()
			hideDialog('appLauncherDialog');
		}
		else if (element.id === "appCloseBtn") {
			selectedAppEntry = null;
			hideDialog('appLauncherDialog');
		}
		else if (element.id === "appDeleteBtn") {
			if(confirm("Are you sure you want to delete this app?")){
				selectedAppEntry = null;
				hideDialog('appLauncherDialog');
			}
		}
		
		// Media Browser Dialog
		else if (element.id === "fileOKBtn") {
			loadSelectedFile();
			hideDialog('mediaBrowserDialog');
		}
		else if (element.id === "fileCloseBtn") {
			selectedFileEntry = null;
			hideDialog('mediaBrowserDialog');
		}
		else if (element.id === "fileDeleteBtn") {
			if(confirm("Are you sure you want to delete this file?")){
				selectedFileEntry = null;
				hideDialog('mediaBrowserDialog');
			}
		}
		
		// Arrangement Dialog
		else if (element.id === "arrangementCloseBtn") {
			hideDialog('arrangementDialog');
		}
		
		// Settings Dialog
		else if (element.id === "settingsCloseBtn") {
			hideDialog('settingsDialog');
		}
		
		
		// Application Selected
		else if (element.id.length > 4 && element.id.substring(0, 4) === "app_") {
			var application = element.getAttribute("application");
			
			if(selectedAppEntry !== null) selectedAppEntry.style.backgroundColor = "transparent";
			selectedAppEntry = document.getElementById('app_row_' + application);
			selectedAppEntry.style.backgroundColor = "#B9D3FF";
		}
		
		// File Selected
		else if (element.id.length > 5 && element.id.substring(0, 5) === "file_") {
			if(selectedFileEntry !== null) selectedFileEntry.style.backgroundColor = "transparent";
			selectedFileEntry = element;
			selectedFileEntry.style.backgroundColor = "#B9D3FF";
		}
		
		// Other
		else {
			//console.log("clicked on: ", element);
		}
	}
	
	function pointerDblClick(event) {
		var element = event.srcElement;
		if(element.id === "sage2UI"){
			displayUI.pointerDblClick();
			event.preventDefault();
		}
		else if (element.id.length > 4 && element.id.substring(0, 4) === "app_") {
			loadSelectedApplication();
			hideDialog('appLauncherDialog');
		}
		else if (element.id.length > 5 && element.id.substring(0, 5) === "file_") {
			loadSelectedFile();
			hideDialog('mediaBrowserDialog');
		}
	}
	
	function pointerScroll(event) {
		if(event.srcElement.id === "sage2UI"){
			displayUI.pointerScroll(event.wheelDelta);
			event.preventDefault();
		}
	}
	
	function touchStart(event) {
		if(event.srcElement.id === "sage2UI") {
			if(event.touches.length === 1){
				var rect = event.srcElement.getBoundingClientRect();
				var touchX = event.touches[0].clientX - rect.left;
				var touchY = event.touches[0].clientY - rect.top;
				displayUI.pointerMove(touchX, touchY);
				displayUI.pointerPress("left");
				touchMode = "translate";
			}
			else if(event.touches.length === 2) {
				var rect = event.srcElement.getBoundingClientRect();
				var touch0X = event.touches[0].clientX - rect.left;
				var touch0Y = event.touches[0].clientY - rect.top;
				var touch1X = event.touches[1].clientX - rect.left;
				var touch1Y = event.touches[1].clientY - rect.top;
				var touchX = parseInt((touch0X+touch1X)/2, 10);
				var touchY = parseInt((touch0Y+touch1Y)/2, 10);
				displayUI.pointerRelease("left");
				displayUI.pointerMove(touchX, touchY);
				touchDist = (touch1X-touch0X)*(touch1X-touch0X) + (touch1Y-touch0Y)*(touch1Y-touch0Y);
				touchMode = "scale";
			}
			else {
				touchMode = "";
			}
			event.preventDefault();
		}
	}
	
	function touchEnd(event) {
		if(event.srcElement.id === "sage2UI"){
			if(touchMode === "translate") {
				displayUI.pointerRelease("left");
			}
			touchMode = "";
			event.preventDefault();
		}
	}
	
	function touchMove(event) {
		if(event.srcElement.id === "sage2UI"){
			if(touchMode === "translate") {
				var rect = event.srcElement.getBoundingClientRect();
				var touchX = event.touches[0].clientX - rect.left;
				var touchY = event.touches[0].clientY - rect.top;
				displayUI.pointerMove(touchX, touchY);
			}
			else if(touchMode === "scale") {
				var rect = event.srcElement.getBoundingClientRect();
				var touch0X = event.touches[0].clientX - rect.left;
				var touch0Y = event.touches[0].clientY - rect.top;
				var touch1X = event.touches[1].clientX - rect.left;
				var touch1Y = event.touches[1].clientY - rect.top;
				var newDist = (touch1X-touch0X)*(touch1X-touch0X) + (touch1Y-touch0Y)*(touch1Y-touch0Y);
				if(Math.abs(newDist - touchDist) > 25){
					var wheelDelta = parseInt((touchDist-newDist)/100, 10);
					displayUI.pointerScroll(wheelDelta);
					touchDist = newDist;
				}
			}
			event.preventDefault();
		}
	}
	
	function keyDown(event) {
		if(displayUI.keyDown(parseInt(event.keyCode, 10))){
			event.preventDefault();
		}
	}
	
	function keyUp(event) {
		if(displayUI.keyUp(parseInt(event.keyCode, 10))){
			event.preventDefault();
		}
	}
	
	function keyPress(event) {
		if(displayUI.keyPress(parseInt(event.charCode, 10))){
			event.preventDefault();
		}
	}
	
	function loadSelectedApplication() {
		if(selectedAppEntry !== null) {
			var application = selectedAppEntry.getAttribute("application");
			
			wsio.emit('loadApplication', {application: application});
		}
	}
	
	function loadSelectedFile() {
		if(selectedFileEntry !== null) {
			var application = selectedFileEntry.getAttribute("application");
			var file = selectedFileEntry.getAttribute("file");
			
			wsio.emit('loadFileFromServer', {application: application, filename: file});
		}
	}
	
	function showDialog(id) {
		var blackoverlay = document.getElementById('blackoverlay');
		var dialog = document.getElementById(id);
		blackoverlay.style.display = "block";
		dialog.style.display = "block";
	}
	
	function hideDialog(id) {
		var blackoverlay = document.getElementById('blackoverlay');
		var dialog = document.getElementById(id);
		blackoverlay.style.display = "none";
		dialog.style.display = "none";
	}
	
	function sagePointerEnabled() {
		// show SAGE2 Pointer dialog
		showDialog('sage2pointerDialog');
	}
	
	function sagePointerDisabled() {
		// hide SAGE2 Pointer dialog
		hideDialog('sage2pointerDialog');
	}
	
	function removeAllChildren(node) {
		while (node.lastChild) {
    		node.removeChild(node.lastChild);
		}
	}
	
	function reloadIfServerRunning(callback) {
		xhr = new XMLHttpRequest();
		xhr.open("GET", "/", true);
		xhr.onreadystatechange = function() {
			if(xhr.readyState == 4 && xhr.status == 200){
				console.log("server ready");
				// when server ready, callback
				callback();
				// and reload the page
				window.location.reload();
			}
		};
		xhr.send();
	}
</script>

<link rel="stylesheet" type="text/css" href="css/style_ui.css" media="screen" />
</head>

<body onload="init()" onresize="resize()">
	<div id="mainUI">
		<div id="displayUI">
			<canvas id="sage2UI"></canvas>
		</div>
		<div id="menuUI">
			<div id="sage2pointerContainer" class="uiButton">
				<img id="sage2pointer" src="images/sage2pointer.svg" width="48" height="48"></img>
				<p>SAGE2 Pointer</p>
			</div>
			<div id="sharescreenContainer" class="uiButton">
				<img id="sharescreen" src="images/sharescreen.svg" width="48" height="48"></img>
				<p>Share Screen</p>
			</div>
			<div id="applauncherContainer" class="uiButton">
				<img id="applauncher" src="images/applauncher.svg" width="48" height="48"></img>
				<p>App Launcher</p>
			</div>
			<div id="mediaBrowserContainer" class="uiButton">
				<img id="mediabrowser" src="images/mediabrowser.svg" width="48" height="48"></img>
				<p>Media Browser</p>
			</div>
			<div id="arrangementContainer" class="uiButton">
				<img id="arrangement" src="images/arrangement.svg" width="48" height="48"></img>
				<p>Arrangement</p>
			</div>
			<div id="settingsContainer" class="uiButton">
				<img id="settings" src="images/settings.svg" width="48" height="48"></img>
				<p>Settings</p>
			</div>
			<div id="infoContainer" class="uiButton">
				<img id="info" src="images/info.svg" width="48" height="48"></img>
				<p>Info</p>
			</div>
		</div>
	</div>
	<div class="clear"></div>
	
	<!-- transparent black overlay for all dialogs -->
	<div id="blackoverlay"></div>
	
	<!-- dialog for the SAGE2 Pointer Help -->
	<div id="sage2pointerDialog" class="dialog">
		<img id="sage2pointerHelp" src="images/SAGE2Pointer-help.svg"></img>
	</div>
	
	<!-- dialog for the App Launcher-->
	<div id="appLauncherDialog" class="dialog">
		<div id="appListContainer">
			<table id="appList">
			</table>
		</div>
		<div id="appButtons">
			<span id="appOKBtn" class="button">OK</span>
			<span id="appCloseBtn" class="button">Close</span>
			<span id="appDeleteBtn" class="button">Delete</span>
		</div>
	</div>
	
	<!-- dialog for the Media Browser -->
	<div id="mediaBrowserDialog" class="dialog">
		<div id="fileTreeList" class="css-treeview">
			<div id="fileListContainer">
				<ul id="fileListElems">
					<li>
						<input type="checkbox" id="images-dir"></input>
						<label for="images-dir">Images</label>
						<ul id="images" class="fileItem"></ul>
					</li>
					<li>
						<input type="checkbox" id="pdfs-dir"></input>
						<label for="pdfs-dir">PDFs</label>
						<ul id="pdfs" class="fileItem"></ul>
					</li>
					<li>
						<input type="checkbox" id="videos-dir"></input>
						<label for="videos-dir">Videos</label>
						<ul id="videos" class="fileItem"></ul>
					</li>
					<li>
						<input type="checkbox" id="sessions-dir"></input>
						<label for="sessions-dir">Sessions</label>
						<ul id="sessions" class="fileItem"></ul>
					</li>
				</ul>
			</div>
		</div>
		<div id="metadata">
			<img id="thumbnail" src="images/blank.png"></img>
			<label id="metadata_text"></label>
		</div>
		<div id="fileButtons">
			<span id="fileOKBtn" class="button">OK</span>
			<span id="fileCloseBtn" class="button">Close</span>
			<span id="fileDeleteBtn" class="button">Delete</span>
		</div>
	</div>
	
	<!-- dialog for the Arrangement-->
	<div id="arrangementDialog" class="dialog">
		<div id="arrangementItems">
			<p>Test 01</p>
			<p>Test 02</p>
			<p>Test 03</p>
		</div>
		<div id="arrangementButtons">
			<span id="arrangementCloseBtn" class="button">Close</span>
		</div>
	</div>
	
	<!-- dialog for the Settings-->
	<div id="settingsDialog" class="dialog">
		<div id="settingsItems">
			<p>Test 01</p>
			<p>Test 02</p>
			<p>Test 03</p>
		</div>
		<div id="settingsButtons">
			<span id="settingsCloseBtn" class="button">Close</span>
		</div>
	</div>
	
	
	<!-- invisible text to test rendered width -->
	<div id="textWidthTest"></div>
</body>
</html>

