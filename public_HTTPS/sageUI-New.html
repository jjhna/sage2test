<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="utf-8">
<title>SAGE2 UI</title>
<!--<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">-->
<script type="text/javascript">
	// SAGE2 is available for use under the SAGE2 Software License 
	//      
	// University of Illinois at Chicago's Electronic Visualization Laboratory (EVL)
	// and University of Hawai'i at Manoa's Laboratory for Advanced Visualization and
	// Applications (LAVA)
	//      
	// See full text, terms and conditions in the LICENSE.txt included file
	//      
	// Copyright (c) 2014
</script>
<script type="text/javascript" src="src/websocket.io.js"></script>
<script type="text/javascript">
	window.URL = (window.URL || window.webkitURL || window.msURL || window.oURL);
	navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
	
	function displayUI() {
		this.config = null;
		
		this.init = function(config) {
			this.config = config;
			
			this.resize();
		};
		
		this.draw = function() {
			var sage2UI = document.getElementById('sage2UI');
			var ctx = sage2UI.getContext('2d');
			
			ctx.fillStyle = "rgba(200, 200, 200, 1.0)";
			ctx.fillRect(0, 0, sage2UI.width, sage2UI.height);
		};
		
		this.resize = function() {
			var displayUI = document.getElementById('displayUI');
			var sage2UI = document.getElementById('sage2UI');
			var menuUI = document.getElementById('menuUI');
			
			var extraHeight = document.getElementById('extraUI').clientHeight;
			var freeWidth   = window.innerWidth  - 185;              // size of menu buttons
			var freeHeight  = window.innerHeight - extraHeight - 20; // size of interaction buttons + margin
			
			var sage2Aspect = this.config.totalWidth / this.config.totalHeight;
			var freeAspect  = freeWidth / freeHeight;
			
			// wide sage2 display (compared to page)
			if(freeAspect < sage2Aspect) {
				sage2UI.width  = Math.floor(freeWidth);
				sage2UI.height = Math.floor(freeWidth / sage2Aspect);
				displayUI.style.marginLeft  = Math.floor((freeWidth-sage2UI.width) / 2 + 10).toString() + "px";
				displayUI.style.marginTop = "10px";
				menuUI.style.marginTop = (sage2UI.height/2 - 128).toString() + "px";
			}
			// tall sage2 display (compared to page)
			else {
				sage2UI.height = Math.floor(freeHeight);
				sage2UI.width  = Math.floor(freeHeight * sage2Aspect);
				displayUI.style.marginLeft  = Math.floor((freeWidth-sage2UI.width) / 2 + 10).toString() + "px";
				displayUI.style.marginTop = "10px";
				menuUI.style.marginTop = (sage2UI.height/2 - 128).toString() + "px";
			}
			if(sage2UI.height < 256) {
				displayUI.style.marginTop = ((256-sage2UI.height) / 2 + 10).toString() + "px";
				menuUI.style.marginTop = "0px";
			}
			
			this.draw();
		};
	}
	
	
	var wsio;
	var sage2UI;
	
	function init() {
		hostname = window.location.hostname;
		port = window.location.port;
		if(window.location.protocol == "http:" && port == "") port = "80";
		if(window.location.protocol == "https:" && port == "") port = "443";
		
		wsio = new websocketIO(window.location.protocol, hostname, parseInt(port));
		wsio.open(function() {
			console.log("open websocket");
			//sagePtr = new sagePointer(wsio);
			//window.postMessage('SAGE2_desktop_capture_enabled', "*");
			
			var clientDescription = {
				clientType: "sageUI",
				sendsPointerData: true,
				sendsMediaStreamFrames: true,
				requestsServerFiles: true,
				sendsWebContentToLoad: true,
				launchesWebBrowser: true,
				sendsVideoSynchonization: false,
				sharesContentWithRemoteServer: false,
				receivesDisplayConfiguration: true,
				receivesClockTime: false,
				requiresFullApps: false,
				requiresAppPositionSizeTypeOnly: true,
				receivesMediaStreamFrames: false,
				receivesWindowModification: true,
				receivesPointerData: false,
				receivesInputEvents: false,
				receivesRemoteServerInfo: false
			};
			wsio.emit('addClient', clientDescription);
		});
		
		// socket close event (i.e. server crashed)		
		wsio.on('close', function (evt) {
			var refresh = setInterval(function() {
				reloadIfServerRunning(function() {
					clearInterval(refresh);
				});
			}, 2000);
		});
		
		wsio.on('setupDisplayConfiguration', function(config) {
			sage2UI = new displayUI();
			sage2UI.init(config);
		});
		
		window.addEventListener('click', pointerClick, false);
	}
	
	function resize() {
		sage2UI.resize();
	}
	
	function pointerClick(event) {
		var element = event.srcElement;
		if(element.id === "applauncher") {
			console.log("App Launcher");
		}
		else if(element.id === "arrangement") {
			console.log("Arrangement");
		}
		else if(element.id === "settings") {
			console.log("Settings");
		}
		else if(element.id === "help") {
			console.log("Help");
		}
	}
	
	function reloadIfServerRunning(callback) {
		// make a dummy request to test the server every 2 sec
		xhr = new XMLHttpRequest();
		xhr.open("GET", "/", true);
		xhr.onreadystatechange = function() {
			if(xhr.readyState == 4 && xhr.status == 200){
				console.log("server ready");
				// when server ready, callback
				callback();
				// and reload the page
				window.location.reload();
			}
		};
		xhr.send();
	}
</script>

<style type="text/css">
body {
	margin: 0px;
	padding: 0px;
}

#mainUI {
	margin: 0px;
	overflow: auto;
}

#displayUI {
	float: left;
	margin: 10px;
}

#menuUI {
	float: left;
	width: 165px;
	height: 256px;
}

.uiButton {
	position: relative;
	width: 155px;
	height: 64px;
}

.uiButton img {
	position: absolute;
	top: 8px;
    left: 8px;
	-webkit-transition: 100ms ease-in-out;
	-moz-transition: 100ms ease-in-out;
	transition: 100ms ease-in-out;
}

.uiButton:hover img {
	-webkit-transform: scale(1.2);
	-moz-transform: scale(1.2);
	transform: scale(1.2);
}

.uiButton p {
	position: absolute;
	top: 12px;
	left: 64px;
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 12px;
	white-space: nowrap;
	padding: 2px 4px 2px 4px;
	color: #FFFFFF;
	background-color: #787878;
	border-radius: 8px;
	opacity: 0.0;
	-webkit-transition: opacity 100ms;
	-moz-transition: opacity 100ms;
	transition: opacity 100ms;
}

.uiButton:hover p {
	opacity: 1.0;
}

.clear {
	clear: both;
}
</style>

<!--
<link rel="stylesheet" type="text/css" href="css/style_mgr.css"       media="screen" />
<link rel="stylesheet" type="text/css" href="css/dialog-polyfill.css" media="screen" />
-->
</head>

<body onload="init()" onresize="resize()">
	<div id="mainUI">
		<div id="displayUI">
			<canvas id="sage2UI"></canvas>
		</div>
		<div id="menuUI">
			<div id="applauncherContainer" class="uiButton">
				<img id="applauncher" src="images/applauncher.svg" width="48" height="48"></img>
				<p>App Launcher</p>
			</div>
			<div id="arrangementContainer" class="uiButton">
				<img id="arrangement" src="images/arrangement.svg" width="48" height="48"></img>
				<p>Arrangement</p>
			</div>
			<div id="settingsContainer" class="uiButton">
				<img id="settings" src="images/settings.svg" width="48" height="48"></img>
				<p>Settings</p>
			</div>
			<div id="helpContainer" class="uiButton">
				<img id="help" src="images/help.svg" width="48" height="48"></img>
				<p>Help</p>
			</div>
		</div>
	</div>
	<div class="clear"></div>
	<div id="extraUI">
		<button id="sage2PointerBtn" type="button">SAGE2 Pointer</button>
	</div>
</body>
</html>

